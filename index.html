<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>বিকাশ হিসাব ক্যালকুলেটর</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f0f2f5; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            flex-direction: column;
            padding-bottom: 70px; /* Space for bottom menu */
        } 
        .container { 
            background-color: #fff; 
            padding: 20px; 
            border-radius: 0px; 
             
            max-width: 500px; 
            width: 90%; 
            margin: 15px auto;
        } 
        h2 { 
            text-align: center; 
            color: #1e3a8a; 
            margin-bottom: 20px; 
            font-size: 1.5rem;
        } 
        label { 
            display: block; 
            margin-top: 15px; 
            font-weight: bold; 
            color: #4a5568; 
            font-size: 0.9rem;
        } 
        input[type="number"], textarea { 
            width: 100%;
            padding: 10px; 
            margin-top: 5px; 
            border: 1px solid #cbd5e0; 
            border-radius: 8px; 
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #f7fafc;
        } 
        textarea { 
            resize: vertical; 
            min-height: 80px; 
        } 
        .input-with-button {
            position: relative;
        }
        .paste-clear-button {
            position: absolute;
            width: 50px;
            bottom: 15px;
            right: 15px;
            padding: 5px 10px;
            border: none;
            background-color: #a0aec0;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.3s ease;
        }
        .paste-clear-button:hover {
            background-color: #718096;
        }
        button { 
            display: block; 
            width: 100%; 
            padding: 12px; 
            margin-top: 25px; 
            background-color: #2563eb; 
            color: #fff; 
            border: none; 
            border-radius: 8px; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: background-color 0.3s ease, transform 0.1s ease; 
        } 
        button:hover { 
            background-color: #1e40af; 
            transform: translateY(-2px);
        } 
        #result-container { 
            margin-top: 25px; 
            padding: 15px; 
            background-color: #e2e8f0; 
            border-left: 4px solid #3b82f6; 
            border-radius: 8px; 
            display: none; 
        } 
        #result-container pre { 
            margin: 0; 
            font-size: 1rem; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            color: #1a202c;
        } 
        #copyButton { 
            background-color: #10b981; 
            margin-top: 10px; 
        } 
        #copyButton:hover { 
            background-color: #059669; 
        } 
        #saveButton {
            background-color: #f59e0b;
            margin-top: 10px;
        }
        #saveButton:hover {
            background-color: #d97706;
        }
        #saveButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .message { 
            margin-top: 10px; 
            color: #e53e3e; 
            text-align: center; 
            font-weight: bold;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            min-width: 600px; /* Minimum width for horizontal scroll */
        }
        .transaction-table th, .transaction-table td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
            font-size: 0.9rem;
        }
        .transaction-table th {
            background-color: #f7fafc;
            color: #2d3748;
            text-transform: uppercase;
            font-weight: 600;
        }
        .transaction-table tr:nth-child(even) {
            background-color: #f7fafc;
        }
        .transaction-table tr:hover {
            background-color: #e2e8f0;
        }
        .bottom-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #1a202c;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
        }
        .bottom-menu-item {
            color: #a0aec0;
            padding: 10px 20px;
            text-decoration: none;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
            transition: color 0.3s ease, background-color 0.3s ease;
            border-radius: 8px;
        }
        .bottom-menu-item.active {
            background-color: #2d3748;
            color: #fff;
        }
        .bottom-menu-item:hover {
            color: #fff;
        }
        .hidden {
            display: none;
        }
        .full-transaction-container {
            margin-top: 20px;
            width: 90%;
            max-width: 900px;
        }
        .search-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .search-controls input {
            flex: 1 1 100px; /* Flex for responsiveness */
        }
        .search-controls button {
            flex: 1 1 auto;
            margin-top: 0;
        }
        .summary-box {
            background-color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #3b82f6;
        }
        .summary-box p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #2d3748;
        }
    </style>
</head>
<body>

<div class="container main-container">
    <h2>লেনদেন প্রবাশি হিসেব</h2>
    <div class="message" id="errorMessage"></div>

    <label for="transactionInput">লেনদেনের বিবরণ (বিকাশ, টাকা, পিন)</label>
    <div class="input-with-button">
        <textarea id="transactionInput" rows="4" placeholder="যেমন: বিকাশ 017xxxxxx23 টাকা 10,000 pin 1234"></textarea>
        <button class="paste-clear-button" id="pasteClearButton">Paste</button>
    </div>

    <label for="rateInput">রেট</label>
    <input type="number" id="rateInput" value="29" step="0.01">

    <label for="chargeInput">চার্জ</label>
    <input type="number" id="chargeInput" value="5" step="0.01">

    <button onclick="calculateAndDisplay()">হিসাব করুন</button>

    <div id="result-container">
        <pre id="resultText"></pre>
        <button id="copyButton" onclick="copyResult()">কপি করুন</button>
        <button id="saveButton" onclick="saveResult()" disabled>সংরক্ষণ করুন</button>
    </div>

</div>

<div class="container transaction-table-container main-container">
    <h3>সর্বশেষ ১০টি লেনদেন</h3>
    <div class="table-container">
        <table class="transaction-table" id="latestTransactionsTable">
            <thead>
                <tr>
                    <th>0</th>
                    <th>বিকাশ</th>
                    <th>টাকা</th>
                    <th>মোট RM</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<div class="container full-transaction-container hidden">
    <h2>সকল ট্রানজেকশন</h2>
    <div class="search-controls">
        <label for="startDate">শুরু:</label>
        <input type="date" id="startDate">
        <label for="endDate">শেষ:</label>
        <input type="date" id="endDate">
        <input type="text" id="searchInput" placeholder="সার্চ করুন...">
        <button onclick="filterTransactions()">ফিল্টার</button>
    </div>
    
    <div class="table-container">
        <table class="transaction-table" id="allTransactionsTable">
            <thead>
                <tr>
                    <th>NN</th>
                    <th>তারিখ</th>
                    <th>বিকাশ</th>
                    <th>টাকা</th>
                    <th>পিন</th>
                    <th>রেট</th>
                    <th>চার্জ</th>
                    <th>মোট RM</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
    <div class="summary-box" id="summaryBox" style="display:none;">
        <p>মোট লেনদেন: <span id="totalTransactions"></span></p>
        <p>মোট টাকা: <span id="totalTaka"></span></p>
        <p>মোট চার্জ: <span id="totalCharge"></span></p>
        <p>মোট RM: <span id="totalRM"></span></p>
    </div>
</div>

<div class="bottom-menu">
    <a href="#" class="bottom-menu-item active" id="lenden-menu">লেনদেন</a>
    <a href="#" class="bottom-menu-item" id="transaction-menu">ট্রানজেকশন</a>
</div>

<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
<script>
    // Firebase configuration from user's input
    const firebaseConfig = {
        apiKey: "AIzaSyCUf3e-mWNCYHqsCcXMwyNJB3GrPIukmAY",
        authDomain: "lenden-probashi.firebaseapp.com",
        databaseURL: "https://lenden-probashi-default-rtdb.firebaseio.com",
        projectId: "lenden-probashi",
        storageBucket: "lenden-probashi.firebasestorage.app",
        messagingSenderId: "523035813260",
        appId: "1:523035813260:web:559485d3de5b363944a2a9",
        measurementId: "G-VDGWDGYHNL"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const transactionsRef = database.ref('transactions');

    const transactionInput = document.getElementById('transactionInput');
    const pasteClearButton = document.getElementById('pasteClearButton');
    const resultContainer = document.getElementById('result-container');
    const saveButton = document.getElementById('saveButton');
    const latestTransactionsTableBody = document.querySelector('#latestTransactionsTable tbody');
    const allTransactionsTableBody = document.querySelector('#allTransactionsTable tbody');
    const mainContainers = document.querySelectorAll('.main-container');
    const fullTransactionContainer = document.querySelector('.full-transaction-container');
    const lendenMenu = document.getElementById('lenden-menu');
    const transactionMenu = document.getElementById('transaction-menu');
    const summaryBox = document.getElementById('summaryBox');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const searchInput = document.getElementById('searchInput');

    // Paste/Clear Button Logic
    transactionInput.addEventListener('input', () => {
        pasteClearButton.textContent = transactionInput.value.trim() === '' ? 'Paste' : 'Clear';
    });

    pasteClearButton.addEventListener('click', async () => {
        if (pasteClearButton.textContent === 'Paste') {
            try {
                const text = await navigator.clipboard.readText();
                transactionInput.value = text;
                pasteClearButton.textContent = 'Clear';
            } catch (err) {
                alert('কপি করার অনুমতি নেই।');
            }
        } else {
            transactionInput.value = '';
            pasteClearButton.textContent = 'Paste';
        }
    });

    // Main Calculation Function
    function calculateAndDisplay() {
        const transactionInput = document.getElementById('transactionInput').value;
        const rateInput = parseFloat(document.getElementById('rateInput').value);
        const chargeInput = parseFloat(document.getElementById('chargeInput').value);
        const resultText = document.getElementById('resultText');
        const errorMessage = document.getElementById('errorMessage');

        errorMessage.innerText = '';
        saveButton.disabled = true;

        const bkashMatch = transactionInput.match(/বিকাশ\s+(\d+)/);
        const takaMatch = transactionInput.match(/টাকা\s+([\d,.]+)/);
        const pinMatches = transactionInput.match(/pin\s+(\d{4})/gi);

        if (!bkashMatch || !takaMatch || isNaN(rateInput) || isNaN(chargeInput)) {
            errorMessage.innerText = "দয়া করে সঠিক ফরম্যাটে সব তথ্য দিন।";
            resultContainer.style.display = 'none';
            return;
        }

        const bkash = bkashMatch[1];
        const taka = parseFloat(takaMatch[1].replace(/,/g, ''));
        const totalRM = (taka / rateInput) + chargeInput;
        const formattedTotal = totalRM.toFixed(2);
        const pins = pinMatches ? pinMatches.map(pin => pin.match(/\d{4}/)[0]).join(', ') : 'N/A';

        const outputData = {
            bkash: bkash,
            taka: taka,
            pins: pins,
            rate: rateInput,
            charge: chargeInput,
            totalRM: parseFloat(formattedTotal)
        };
        
        window.currentTransactionData = outputData;

        let output = `বিকাশ: ${outputData.bkash}\n`;
        output += `টাকা: ${outputData.taka.toLocaleString('en-US')}\n`;
        output += `পিন: ${outputData.pins}\n`;
        output += `রেট: ${outputData.rate}\n`;
        output += `চার্জ: ${outputData.charge}\n`;
        output += `মোট RM: ${outputData.totalRM}`;
        
        resultText.innerText = output.trim();
        resultContainer.style.display = 'block';
        saveButton.disabled = false;
    }

    // Save to Firebase Function
    function saveResult() {
        const dataToSave = window.currentTransactionData;
        if (!dataToSave) {
            alert("হিসাব না করে সংরক্ষণ করা সম্ভব নয়।");
            return;
        }

        saveButton.disabled = true;
        saveButton.textContent = 'সংরক্ষণ হচ্ছে...';

        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = now.getFullYear();
        const dateString = `${day}/${month}/${year}`;

        const transactionData = {
            ...dataToSave,
            date: dateString,
            timestamp: now.getTime()
        };

        transactionsRef.push(transactionData)
            .then(() => {
                alert("ডেটা সফলভাবে সংরক্ষণ করা হয়েছে!");
                saveButton.textContent = 'সংরক্ষণ করুন';
                saveButton.disabled = false;
                
                fetchLatestTransactions();
            })
            .catch((error) => {
                console.error("Error saving data: ", error);
                alert("ডেটা সংরক্ষণ করা সম্ভব হয়নি: " + error.message);
                saveButton.textContent = 'সংরক্ষণ করুন';
                saveButton.disabled = false;
            });
    }

    // Copy to Clipboard
    function copyResult() {
        const resultText = document.getElementById('resultText').innerText;
        navigator.clipboard.writeText(resultText).then(() => {
            alert("লেখাটি কপি করা হয়েছে!");
        }).catch(err => {
            alert("কপি করা সম্ভব হয়নি।");
        });
    }
    
    // Add row to table function
    function addTransactionToTable(tableBody, transaction, rowNumber, isLatest) {
        const row = tableBody.insertRow(-1);

        const nnCell = row.insertCell(0);
        nnCell.textContent = rowNumber;

        if (!isLatest) {
            const dateCell = row.insertCell(1);
            dateCell.textContent = transaction.date;
        }

        const bkashCell = row.insertCell(isLatest ? 1 : 2);
        bkashCell.textContent = transaction.bkash;

        const takaCell = row.insertCell(isLatest ? 2 : 3);
        takaCell.textContent = transaction.taka.toLocaleString('en-US');

        if (!isLatest) {
            const pinsCell = row.insertCell(4);
            pinsCell.textContent = transaction.pins;
            
            const rateCell = row.insertCell(5);
            rateCell.textContent = transaction.rate;

            const chargeCell = row.insertCell(6);
            chargeCell.textContent = transaction.charge;
        }
        
        const totalRMCell = row.insertCell(isLatest ? 3 : 7);
        totalRMCell.textContent = transaction.totalRM.toFixed(2);
    }

    // Fetch latest 10 transactions
    function fetchLatestTransactions() {
        latestTransactionsTableBody.innerHTML = '';
        transactionsRef.orderByChild('timestamp').limitToLast(10).once('value', (snapshot) => {
            const transactions = [];
            snapshot.forEach(childSnapshot => {
                transactions.push(childSnapshot.val());
            });
            transactions.reverse().forEach((transaction, index) => {
                addTransactionToTable(latestTransactionsTableBody, transaction, index + 1, true);
            });
        });
    }

    // Fetch all transactions for the full view
    function fetchAllTransactions(filters = {}) {
        allTransactionsTableBody.innerHTML = '';
        
        transactionsRef.orderByChild('timestamp').once('value', (snapshot) => {
            const transactions = [];
            snapshot.forEach(childSnapshot => {
                transactions.push(childSnapshot.val());
            });
            
            transactions.reverse();

            const filteredTransactions = transactions.filter(transaction => {
                const searchMatch = !filters.searchQuery || 
                                    JSON.stringify(transaction).toLowerCase().includes(filters.searchQuery.toLowerCase());
                                    
                const [day, month, year] = transaction.date.split('/').map(Number);
                const transactionDate = new Date(year, month - 1, day);
                const startDate = filters.startDate ? new Date(filters.startDate) : null;
                const endDate = filters.endDate ? new Date(filters.endDate) : null;

                const dateMatch = (!startDate || transactionDate >= startDate) &&
                                  (!endDate || transactionDate <= endDate);
                
                return dateMatch && searchMatch;
            });

            let totalTaka = 0;
            let totalCharge = 0;
            let totalRM = 0;
            
            filteredTransactions.forEach((transaction, index) => {
                addTransactionToTable(allTransactionsTableBody, transaction, index + 1, false);
                totalTaka += transaction.taka;
                totalCharge += transaction.charge;
                totalRM += transaction.totalRM;
            });

            document.getElementById('totalTransactions').textContent = filteredTransactions.length;
            document.getElementById('totalTaka').textContent = totalTaka.toLocaleString('en-US');
            document.getElementById('totalCharge').textContent = totalCharge.toFixed(2);
            document.getElementById('totalRM').textContent = totalRM.toFixed(2);
            summaryBox.style.display = 'block';
        });
    }

    // Filter transactions function
    function filterTransactions() {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        const searchQuery = searchInput.value;
        
        fetchAllTransactions({
            startDate: startDate,
            endDate: endDate,
            searchQuery: searchQuery
        });
    }
    
    // Menu logic
    lendenMenu.addEventListener('click', (e) => {
        e.preventDefault();
        lendenMenu.classList.add('active');
        transactionMenu.classList.remove('active');
        mainContainers.forEach(el => el.classList.remove('hidden'));
        fullTransactionContainer.classList.add('hidden');
        fetchLatestTransactions();
    });

    transactionMenu.addEventListener('click', (e) => {
        e.preventDefault();
        transactionMenu.classList.add('active');
        lendenMenu.classList.remove('active');
        mainContainers.forEach(el => el.classList.add('hidden'));
        fullTransactionContainer.classList.remove('hidden');
        fetchAllTransactions();
    });

    // Initial load
    window.onload = fetchLatestTransactions;

</script>

</body>
</html>
